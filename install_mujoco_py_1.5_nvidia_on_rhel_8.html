<h1 id="install-mujoco-1.5-on-rhel-8-and-config-it-to-use-nvidias-opengl-implementation">Install Mujoco 1.5 on RHEL 8 and config it to use Nvidia’s OpenGL implementation</h1>
<p>This is to make mujoco-py 1.5 work with the nvidia driver.</p>
<h2 id="steps">Steps:</h2>
<ul>
<li>Nvidia driver is installed with the official CentOS repo</li>
<li><code>dnf install libglvnd-opengl libglvnd-devel glfw glfw-devel libGLEW</code> (this won’t install any mesa related stuff)</li>
<li><code>dnf install patchelf</code> to patch some system .so (will make a copy in the build folder, won’t modify the original one)</li>
<li><code>pip3 download mujoco-py==1.50.1.1</code>, unzip the tar and cd into it</li>
<li>replace <code>mujoco_py/builder.py</code> with the following one</li>
<li><code>python setup.py build</code> and <code>python setup.py install</code></li>
<li>install other dependent packages if the build process requires them</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="im">import</span> distutils</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="im">import</span> imp</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="im">import</span> os</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="im">import</span> shutil</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="im">import</span> subprocess</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="im">import</span> sys</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="im">from</span> distutils.core <span class="im">import</span> Extension</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="im">from</span> distutils.dist <span class="im">import</span> Distribution</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="im">from</span> distutils.sysconfig <span class="im">import</span> customize_compiler</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="im">from</span> os.path <span class="im">import</span> abspath, dirname, exists, join, getmtime</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="im">from</span> shutil <span class="im">import</span> move</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="im">from</span> Cython.Build <span class="im">import</span> cythonize</a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="im">from</span> Cython.Distutils.old_build_ext <span class="im">import</span> old_build_ext <span class="im">as</span> build_ext</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="im">from</span> mujoco_py.utils <span class="im">import</span> discover_mujoco</a>
<a class="sourceLine" id="cb1-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="kw">def</span> load_cython_ext(mjpro_path):</a>
<a class="sourceLine" id="cb1-21" data-line-number="21">    <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="co">    Loads the cymj Cython extension. This is safe to be called from</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="co">    multiple processes running on the same machine.</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="co">    Cython only gives us back the raw path, regardless of whether</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="co">    it found a cached version or actually compiled. Since we do</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="co">    non-idempotent postprocessing of the DLL, be extra careful</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="co">    to only do that once and then atomically move to the final</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="co">    location.</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31">    <span class="cf">if</span> (<span class="st">&#39;glfw&#39;</span> <span class="kw">in</span> sys.modules <span class="kw">and</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32">            <span class="st">&#39;mujoco&#39;</span> <span class="kw">in</span> abspath(sys.modules[<span class="st">&quot;glfw&quot;</span>].<span class="va">__file__</span>)):</a>
<a class="sourceLine" id="cb1-33" data-line-number="33">        <span class="bu">print</span>(<span class="st">&#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="st">WARNING: Existing glfw python module detected!</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="st">MuJoCo comes with its own version of GLFW, so it&#39;s preferable to use that one.</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="st">The easy solution is to `import mujoco_py` _before_ `import glfw`.</span></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"><span class="st">&#39;&#39;&#39;</span>)</a>
<a class="sourceLine" id="cb1-40" data-line-number="40"></a>
<a class="sourceLine" id="cb1-41" data-line-number="41">    <span class="cf">if</span> sys.platform <span class="op">==</span> <span class="st">&#39;darwin&#39;</span>:</a>
<a class="sourceLine" id="cb1-42" data-line-number="42">        Builder <span class="op">=</span> MacExtensionBuilder</a>
<a class="sourceLine" id="cb1-43" data-line-number="43">    <span class="cf">elif</span> sys.platform <span class="op">==</span> <span class="st">&#39;linux&#39;</span>:</a>
<a class="sourceLine" id="cb1-44" data-line-number="44">        Builder <span class="op">=</span> LinuxGPUExtensionBuilder</a>
<a class="sourceLine" id="cb1-45" data-line-number="45">    <span class="cf">elif</span> sys.platform.startswith(<span class="st">&quot;win&quot;</span>):</a>
<a class="sourceLine" id="cb1-46" data-line-number="46">        Builder <span class="op">=</span> WindowsExtensionBuilder</a>
<a class="sourceLine" id="cb1-47" data-line-number="47">    <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb1-48" data-line-number="48">        <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">&quot;Unsupported platform </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> sys.platform)</a>
<a class="sourceLine" id="cb1-49" data-line-number="49"></a>
<a class="sourceLine" id="cb1-50" data-line-number="50">    builder <span class="op">=</span> Builder(mjpro_path)</a>
<a class="sourceLine" id="cb1-51" data-line-number="51">    cext_so_path <span class="op">=</span> builder.get_so_file_path()</a>
<a class="sourceLine" id="cb1-52" data-line-number="52">    <span class="cf">if</span> <span class="kw">not</span> exists(cext_so_path):</a>
<a class="sourceLine" id="cb1-53" data-line-number="53">        cext_so_path <span class="op">=</span> builder.build()</a>
<a class="sourceLine" id="cb1-54" data-line-number="54">    mod <span class="op">=</span> imp.load_dynamic(<span class="st">&quot;cymj&quot;</span>, cext_so_path)</a>
<a class="sourceLine" id="cb1-55" data-line-number="55">    <span class="cf">return</span> mod</a>
<a class="sourceLine" id="cb1-56" data-line-number="56"></a>
<a class="sourceLine" id="cb1-57" data-line-number="57"></a>
<a class="sourceLine" id="cb1-58" data-line-number="58"><span class="kw">class</span> custom_build_ext(build_ext):</a>
<a class="sourceLine" id="cb1-59" data-line-number="59">    <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-60" data-line-number="60"><span class="co">    Custom build_ext to suppress the &quot;-Wstrict-prototypes&quot; warning.</span></a>
<a class="sourceLine" id="cb1-61" data-line-number="61"><span class="co">    It arises from the fact that we&#39;re using C++. This seems to be</span></a>
<a class="sourceLine" id="cb1-62" data-line-number="62"><span class="co">    the cleanest way to get rid of the extra flag.</span></a>
<a class="sourceLine" id="cb1-63" data-line-number="63"></a>
<a class="sourceLine" id="cb1-64" data-line-number="64"><span class="co">    See http://stackoverflow.com/a/36293331/248400</span></a>
<a class="sourceLine" id="cb1-65" data-line-number="65"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-66" data-line-number="66"></a>
<a class="sourceLine" id="cb1-67" data-line-number="67">    <span class="kw">def</span> build_extensions(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-68" data-line-number="68">        customize_compiler(<span class="va">self</span>.compiler)</a>
<a class="sourceLine" id="cb1-69" data-line-number="69"></a>
<a class="sourceLine" id="cb1-70" data-line-number="70">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb1-71" data-line-number="71">            <span class="va">self</span>.compiler.compiler_so.remove(<span class="st">&quot;-Wstrict-prototypes&quot;</span>)</a>
<a class="sourceLine" id="cb1-72" data-line-number="72">        <span class="cf">except</span> (<span class="pp">AttributeError</span>, <span class="pp">ValueError</span>):</a>
<a class="sourceLine" id="cb1-73" data-line-number="73">            <span class="cf">pass</span></a>
<a class="sourceLine" id="cb1-74" data-line-number="74">        build_ext.build_extensions(<span class="va">self</span>)</a>
<a class="sourceLine" id="cb1-75" data-line-number="75"></a>
<a class="sourceLine" id="cb1-76" data-line-number="76"></a>
<a class="sourceLine" id="cb1-77" data-line-number="77"><span class="kw">def</span> fix_shared_library(so_file, name, library_path):</a>
<a class="sourceLine" id="cb1-78" data-line-number="78">    <span class="bu">print</span>(<span class="st">&#39;fake patching&#39;</span>, so_file, name, library_path)</a>
<a class="sourceLine" id="cb1-79" data-line-number="79">    ldd_output <span class="op">=</span> subprocess.check_output(</a>
<a class="sourceLine" id="cb1-80" data-line-number="80">        [<span class="st">&#39;ldd&#39;</span>, so_file]).decode(<span class="st">&#39;utf-8&#39;</span>)</a>
<a class="sourceLine" id="cb1-81" data-line-number="81"></a>
<a class="sourceLine" id="cb1-82" data-line-number="82">    <span class="cf">if</span> name <span class="kw">in</span> ldd_output:</a>
<a class="sourceLine" id="cb1-83" data-line-number="83">        subprocess.check_call([<span class="st">&#39;patchelf&#39;</span>,</a>
<a class="sourceLine" id="cb1-84" data-line-number="84">                               <span class="st">&#39;--remove-needed&#39;</span>,</a>
<a class="sourceLine" id="cb1-85" data-line-number="85">                               name,</a>
<a class="sourceLine" id="cb1-86" data-line-number="86">                               so_file])</a>
<a class="sourceLine" id="cb1-87" data-line-number="87">    subprocess.check_call(</a>
<a class="sourceLine" id="cb1-88" data-line-number="88">        [<span class="st">&#39;patchelf&#39;</span>, <span class="st">&#39;--add-needed&#39;</span>,</a>
<a class="sourceLine" id="cb1-89" data-line-number="89">         library_path,</a>
<a class="sourceLine" id="cb1-90" data-line-number="90">         so_file])</a>
<a class="sourceLine" id="cb1-91" data-line-number="91"></a>
<a class="sourceLine" id="cb1-92" data-line-number="92"></a>
<a class="sourceLine" id="cb1-93" data-line-number="93"><span class="kw">class</span> MujocoExtensionBuilder():</a>
<a class="sourceLine" id="cb1-94" data-line-number="94"></a>
<a class="sourceLine" id="cb1-95" data-line-number="95">    CYMJ_DIR_PATH <span class="op">=</span> abspath(dirname(<span class="va">__file__</span>))</a>
<a class="sourceLine" id="cb1-96" data-line-number="96"></a>
<a class="sourceLine" id="cb1-97" data-line-number="97">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, mjpro_path):</a>
<a class="sourceLine" id="cb1-98" data-line-number="98">        <span class="va">self</span>.mjpro_path <span class="op">=</span> mjpro_path</a>
<a class="sourceLine" id="cb1-99" data-line-number="99">        <span class="va">self</span>.extension <span class="op">=</span> Extension(</a>
<a class="sourceLine" id="cb1-100" data-line-number="100">            <span class="st">&#39;mujoco_py.cymj&#39;</span>,</a>
<a class="sourceLine" id="cb1-101" data-line-number="101">            sources<span class="op">=</span>[join(<span class="va">self</span>.CYMJ_DIR_PATH, <span class="st">&quot;cymj.pyx&quot;</span>)],</a>
<a class="sourceLine" id="cb1-102" data-line-number="102">            include_dirs<span class="op">=</span>[</a>
<a class="sourceLine" id="cb1-103" data-line-number="103">                <span class="va">self</span>.CYMJ_DIR_PATH,</a>
<a class="sourceLine" id="cb1-104" data-line-number="104">                join(mjpro_path, <span class="st">&#39;include&#39;</span>),</a>
<a class="sourceLine" id="cb1-105" data-line-number="105">                np.get_include(),</a>
<a class="sourceLine" id="cb1-106" data-line-number="106">            ],</a>
<a class="sourceLine" id="cb1-107" data-line-number="107">            libraries<span class="op">=</span>[<span class="st">&#39;mujoco150&#39;</span>],</a>
<a class="sourceLine" id="cb1-108" data-line-number="108">            library_dirs<span class="op">=</span>[join(mjpro_path, <span class="st">&#39;bin&#39;</span>)],</a>
<a class="sourceLine" id="cb1-109" data-line-number="109">            extra_compile_args<span class="op">=</span>[</a>
<a class="sourceLine" id="cb1-110" data-line-number="110">                <span class="st">&#39;-fopenmp&#39;</span>,  <span class="co"># needed for OpenMP</span></a>
<a class="sourceLine" id="cb1-111" data-line-number="111">                <span class="st">&#39;-w&#39;</span>,  <span class="co"># suppress numpy compilation warnings</span></a>
<a class="sourceLine" id="cb1-112" data-line-number="112">            ],</a>
<a class="sourceLine" id="cb1-113" data-line-number="113">            extra_link_args<span class="op">=</span>[<span class="st">&#39;-fopenmp&#39;</span>],</a>
<a class="sourceLine" id="cb1-114" data-line-number="114">            language<span class="op">=</span><span class="st">&#39;c&#39;</span>)</a>
<a class="sourceLine" id="cb1-115" data-line-number="115"></a>
<a class="sourceLine" id="cb1-116" data-line-number="116">    <span class="kw">def</span> build(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-117" data-line-number="117">        built_so_file_path <span class="op">=</span> <span class="va">self</span>._build_impl()</a>
<a class="sourceLine" id="cb1-118" data-line-number="118">        new_so_file_path <span class="op">=</span> <span class="va">self</span>.get_so_file_path()</a>
<a class="sourceLine" id="cb1-119" data-line-number="119">        move(built_so_file_path, new_so_file_path)</a>
<a class="sourceLine" id="cb1-120" data-line-number="120">        <span class="cf">return</span> new_so_file_path</a>
<a class="sourceLine" id="cb1-121" data-line-number="121"></a>
<a class="sourceLine" id="cb1-122" data-line-number="122">    <span class="kw">def</span> _build_impl(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-123" data-line-number="123">        dist <span class="op">=</span> Distribution({</a>
<a class="sourceLine" id="cb1-124" data-line-number="124">            <span class="st">&quot;script_name&quot;</span>: <span class="va">None</span>,</a>
<a class="sourceLine" id="cb1-125" data-line-number="125">            <span class="st">&quot;script_args&quot;</span>: [<span class="st">&quot;build_ext&quot;</span>]</a>
<a class="sourceLine" id="cb1-126" data-line-number="126">        })</a>
<a class="sourceLine" id="cb1-127" data-line-number="127">        dist.ext_modules <span class="op">=</span> cythonize([<span class="va">self</span>.extension])</a>
<a class="sourceLine" id="cb1-128" data-line-number="128">        dist.include_dirs <span class="op">=</span> []</a>
<a class="sourceLine" id="cb1-129" data-line-number="129">        dist.cmdclass <span class="op">=</span> {<span class="st">&#39;build_ext&#39;</span>: custom_build_ext}</a>
<a class="sourceLine" id="cb1-130" data-line-number="130">        build <span class="op">=</span> dist.get_command_obj(<span class="st">&#39;build&#39;</span>)</a>
<a class="sourceLine" id="cb1-131" data-line-number="131">        <span class="co"># following the convention of cython&#39;s pyxbuild and naming</span></a>
<a class="sourceLine" id="cb1-132" data-line-number="132">        <span class="co"># base directory &quot;_pyxbld&quot;</span></a>
<a class="sourceLine" id="cb1-133" data-line-number="133">        build.build_base <span class="op">=</span> join(<span class="va">self</span>.CYMJ_DIR_PATH, <span class="st">&#39;generated&#39;</span>,</a>
<a class="sourceLine" id="cb1-134" data-line-number="134">                                <span class="st">&#39;_pyxbld_</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> <span class="va">self</span>.__class__.<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb1-135" data-line-number="135">        dist.parse_command_line()</a>
<a class="sourceLine" id="cb1-136" data-line-number="136">        obj_build_ext <span class="op">=</span> dist.get_command_obj(<span class="st">&quot;build_ext&quot;</span>)</a>
<a class="sourceLine" id="cb1-137" data-line-number="137">        dist.run_commands()</a>
<a class="sourceLine" id="cb1-138" data-line-number="138">        built_so_file_path, <span class="op">=</span> obj_build_ext.get_outputs()</a>
<a class="sourceLine" id="cb1-139" data-line-number="139">        <span class="cf">return</span> built_so_file_path</a>
<a class="sourceLine" id="cb1-140" data-line-number="140"></a>
<a class="sourceLine" id="cb1-141" data-line-number="141">    <span class="kw">def</span> get_so_file_path(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-142" data-line-number="142">        dir_path <span class="op">=</span> abspath(dirname(<span class="va">__file__</span>))</a>
<a class="sourceLine" id="cb1-143" data-line-number="143">        <span class="cf">return</span> join(dir_path, <span class="st">&quot;generated&quot;</span>, <span class="st">&quot;cymj_</span><span class="sc">%s</span><span class="st">.so&quot;</span> <span class="op">%</span> (</a>
<a class="sourceLine" id="cb1-144" data-line-number="144">            <span class="va">self</span>.__class__.<span class="va">__name__</span>.lower()))</a>
<a class="sourceLine" id="cb1-145" data-line-number="145"></a>
<a class="sourceLine" id="cb1-146" data-line-number="146"></a>
<a class="sourceLine" id="cb1-147" data-line-number="147"><span class="kw">class</span> WindowsExtensionBuilder(MujocoExtensionBuilder):</a>
<a class="sourceLine" id="cb1-148" data-line-number="148"></a>
<a class="sourceLine" id="cb1-149" data-line-number="149">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, mjpro_path):</a>
<a class="sourceLine" id="cb1-150" data-line-number="150">        <span class="bu">super</span>().<span class="fu">__init__</span>(mjpro_path)</a>
<a class="sourceLine" id="cb1-151" data-line-number="151">        os.environ[<span class="st">&quot;PATH&quot;</span>] <span class="op">+=</span> <span class="st">&quot;;&quot;</span> <span class="op">+</span> join(mjpro_path, <span class="st">&quot;bin&quot;</span>)</a>
<a class="sourceLine" id="cb1-152" data-line-number="152">        <span class="va">self</span>.extension.sources.append(<span class="va">self</span>.CYMJ_DIR_PATH <span class="op">+</span> <span class="st">&quot;/gl/dummyshim.c&quot;</span>)</a>
<a class="sourceLine" id="cb1-153" data-line-number="153"></a>
<a class="sourceLine" id="cb1-154" data-line-number="154"></a>
<a class="sourceLine" id="cb1-155" data-line-number="155"><span class="kw">class</span> LinuxCPUExtensionBuilder(MujocoExtensionBuilder):</a>
<a class="sourceLine" id="cb1-156" data-line-number="156"></a>
<a class="sourceLine" id="cb1-157" data-line-number="157">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, mjpro_path):</a>
<a class="sourceLine" id="cb1-158" data-line-number="158">        <span class="bu">super</span>().<span class="fu">__init__</span>(mjpro_path)</a>
<a class="sourceLine" id="cb1-159" data-line-number="159"></a>
<a class="sourceLine" id="cb1-160" data-line-number="160">        <span class="va">self</span>.extension.sources.append(</a>
<a class="sourceLine" id="cb1-161" data-line-number="161">            join(<span class="va">self</span>.CYMJ_DIR_PATH, <span class="st">&quot;gl&quot;</span>, <span class="st">&quot;osmesashim.c&quot;</span>))</a>
<a class="sourceLine" id="cb1-162" data-line-number="162">        <span class="va">self</span>.extension.libraries.extend([<span class="st">&#39;glewosmesa&#39;</span>, <span class="st">&#39;OSMesa&#39;</span>])</a>
<a class="sourceLine" id="cb1-163" data-line-number="163">        <span class="va">self</span>.extension.runtime_library_dirs <span class="op">=</span> [join(mjpro_path, <span class="st">&#39;bin&#39;</span>)]</a>
<a class="sourceLine" id="cb1-164" data-line-number="164"></a>
<a class="sourceLine" id="cb1-165" data-line-number="165"></a>
<a class="sourceLine" id="cb1-166" data-line-number="166"><span class="kw">class</span> LinuxGPUExtensionBuilder(MujocoExtensionBuilder):</a>
<a class="sourceLine" id="cb1-167" data-line-number="167"></a>
<a class="sourceLine" id="cb1-168" data-line-number="168">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, mjpro_path):</a>
<a class="sourceLine" id="cb1-169" data-line-number="169">        <span class="bu">super</span>().<span class="fu">__init__</span>(mjpro_path)</a>
<a class="sourceLine" id="cb1-170" data-line-number="170"></a>
<a class="sourceLine" id="cb1-171" data-line-number="171">        <span class="va">self</span>.extension.sources.append(<span class="va">self</span>.CYMJ_DIR_PATH <span class="op">+</span> <span class="st">&quot;/gl/eglshim.c&quot;</span>)</a>
<a class="sourceLine" id="cb1-172" data-line-number="172">        <span class="va">self</span>.extension.include_dirs.append(<span class="va">self</span>.CYMJ_DIR_PATH <span class="op">+</span> <span class="st">&#39;/vendor/egl&#39;</span>)</a>
<a class="sourceLine" id="cb1-173" data-line-number="173">        <span class="va">self</span>.extension.libraries.extend([<span class="st">&#39;glewegl&#39;</span>])</a>
<a class="sourceLine" id="cb1-174" data-line-number="174">        <span class="va">self</span>.extension.runtime_library_dirs <span class="op">=</span> [join(mjpro_path, <span class="st">&#39;bin&#39;</span>)]</a>
<a class="sourceLine" id="cb1-175" data-line-number="175"></a>
<a class="sourceLine" id="cb1-176" data-line-number="176">    <span class="kw">def</span> _build_impl(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-177" data-line-number="177">        so_file_path <span class="op">=</span> <span class="bu">super</span>()._build_impl()</a>
<a class="sourceLine" id="cb1-178" data-line-number="178">        nvidia_lib_dir <span class="op">=</span> <span class="st">&#39;/usr/lib64/&#39;</span></a>
<a class="sourceLine" id="cb1-179" data-line-number="179">        fix_shared_library(so_file_path, <span class="st">&#39;libOpenGL.so&#39;</span>,</a>
<a class="sourceLine" id="cb1-180" data-line-number="180">                           join(nvidia_lib_dir, <span class="st">&#39;libOpenGL.so.0&#39;</span>))</a>
<a class="sourceLine" id="cb1-181" data-line-number="181">        fix_shared_library(so_file_path, <span class="st">&#39;libEGL.so&#39;</span>,</a>
<a class="sourceLine" id="cb1-182" data-line-number="182">                           join(nvidia_lib_dir, <span class="st">&#39;libEGL.so.1&#39;</span>))</a>
<a class="sourceLine" id="cb1-183" data-line-number="183">        <span class="cf">return</span> so_file_path</a>
<a class="sourceLine" id="cb1-184" data-line-number="184"></a>
<a class="sourceLine" id="cb1-185" data-line-number="185"></a>
<a class="sourceLine" id="cb1-186" data-line-number="186"><span class="kw">class</span> MacExtensionBuilder(MujocoExtensionBuilder):</a>
<a class="sourceLine" id="cb1-187" data-line-number="187"></a>
<a class="sourceLine" id="cb1-188" data-line-number="188">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, mjpro_path):</a>
<a class="sourceLine" id="cb1-189" data-line-number="189">        <span class="bu">super</span>().<span class="fu">__init__</span>(mjpro_path)</a>
<a class="sourceLine" id="cb1-190" data-line-number="190"></a>
<a class="sourceLine" id="cb1-191" data-line-number="191">        <span class="va">self</span>.extension.sources.append(<span class="va">self</span>.CYMJ_DIR_PATH <span class="op">+</span> <span class="st">&quot;/gl/dummyshim.c&quot;</span>)</a>
<a class="sourceLine" id="cb1-192" data-line-number="192">        <span class="va">self</span>.extension.libraries.extend([<span class="st">&#39;glfw.3&#39;</span>])</a>
<a class="sourceLine" id="cb1-193" data-line-number="193">        <span class="va">self</span>.extension.define_macros <span class="op">=</span> [(<span class="st">&#39;ONMAC&#39;</span>, <span class="va">None</span>)]</a>
<a class="sourceLine" id="cb1-194" data-line-number="194">        <span class="va">self</span>.extension.runtime_library_dirs <span class="op">=</span> [join(mjpro_path, <span class="st">&#39;bin&#39;</span>)]</a>
<a class="sourceLine" id="cb1-195" data-line-number="195"></a>
<a class="sourceLine" id="cb1-196" data-line-number="196">    <span class="kw">def</span> _build_impl(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-197" data-line-number="197">        <span class="co"># Prefer GCC 6 for now since GCC 7 may behave differently.</span></a>
<a class="sourceLine" id="cb1-198" data-line-number="198">        c_compilers <span class="op">=</span> [<span class="st">&#39;/usr/local/bin/gcc-6&#39;</span>, <span class="st">&#39;/usr/local/bin/gcc-7&#39;</span>]</a>
<a class="sourceLine" id="cb1-199" data-line-number="199">        available_c_compiler <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb1-200" data-line-number="200">        <span class="cf">for</span> c_compiler <span class="kw">in</span> c_compilers:</a>
<a class="sourceLine" id="cb1-201" data-line-number="201">            <span class="cf">if</span> distutils.spawn.find_executable(c_compiler) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="cb1-202" data-line-number="202">                available_c_compiler <span class="op">=</span> c_compiler</a>
<a class="sourceLine" id="cb1-203" data-line-number="203">                <span class="cf">break</span></a>
<a class="sourceLine" id="cb1-204" data-line-number="204">        <span class="cf">if</span> available_c_compiler <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="cb1-205" data-line-number="205">            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(</a>
<a class="sourceLine" id="cb1-206" data-line-number="206">                <span class="st">&#39;Could not find GCC 6 or GCC 7 executable.</span><span class="ch">\n\n</span><span class="st">&#39;</span></a>
<a class="sourceLine" id="cb1-207" data-line-number="207">                <span class="st">&#39;HINT: On OS X, install GCC 6 with &#39;</span></a>
<a class="sourceLine" id="cb1-208" data-line-number="208">                <span class="st">&#39;`brew install gcc --without-multilib`.&#39;</span>)</a>
<a class="sourceLine" id="cb1-209" data-line-number="209">        os.environ[<span class="st">&#39;CC&#39;</span>] <span class="op">=</span> available_c_compiler</a>
<a class="sourceLine" id="cb1-210" data-line-number="210"></a>
<a class="sourceLine" id="cb1-211" data-line-number="211">        so_file_path <span class="op">=</span> <span class="bu">super</span>()._build_impl()</a>
<a class="sourceLine" id="cb1-212" data-line-number="212">        <span class="kw">del</span> os.environ[<span class="st">&#39;CC&#39;</span>]</a>
<a class="sourceLine" id="cb1-213" data-line-number="213">        <span class="cf">return</span> <span class="va">self</span>.manually_link_libraries(so_file_path)</a>
<a class="sourceLine" id="cb1-214" data-line-number="214"></a>
<a class="sourceLine" id="cb1-215" data-line-number="215">    <span class="kw">def</span> manually_link_libraries(<span class="va">self</span>, raw_cext_dll_path):</a>
<a class="sourceLine" id="cb1-216" data-line-number="216">        root, ext <span class="op">=</span> os.path.splitext(raw_cext_dll_path)</a>
<a class="sourceLine" id="cb1-217" data-line-number="217">        final_cext_dll_path <span class="op">=</span> root <span class="op">+</span> <span class="st">&#39;_final&#39;</span> <span class="op">+</span> ext</a>
<a class="sourceLine" id="cb1-218" data-line-number="218"></a>
<a class="sourceLine" id="cb1-219" data-line-number="219">        <span class="co"># If someone else already built the final DLL, don&#39;t bother</span></a>
<a class="sourceLine" id="cb1-220" data-line-number="220">        <span class="co"># recreating it here, even though this should still be idempotent.</span></a>
<a class="sourceLine" id="cb1-221" data-line-number="221">        <span class="cf">if</span> (exists(final_cext_dll_path) <span class="kw">and</span></a>
<a class="sourceLine" id="cb1-222" data-line-number="222">                getmtime(final_cext_dll_path) <span class="op">&gt;=</span> getmtime(raw_cext_dll_path)):</a>
<a class="sourceLine" id="cb1-223" data-line-number="223">            <span class="cf">return</span> final_cext_dll_path</a>
<a class="sourceLine" id="cb1-224" data-line-number="224"></a>
<a class="sourceLine" id="cb1-225" data-line-number="225">        tmp_final_cext_dll_path <span class="op">=</span> final_cext_dll_path <span class="op">+</span> <span class="st">&#39;~&#39;</span></a>
<a class="sourceLine" id="cb1-226" data-line-number="226">        shutil.copyfile(raw_cext_dll_path, tmp_final_cext_dll_path)</a>
<a class="sourceLine" id="cb1-227" data-line-number="227"></a>
<a class="sourceLine" id="cb1-228" data-line-number="228">        mj_bin_path <span class="op">=</span> join(<span class="va">self</span>.mjpro_path, <span class="st">&#39;bin&#39;</span>)</a>
<a class="sourceLine" id="cb1-229" data-line-number="229"></a>
<a class="sourceLine" id="cb1-230" data-line-number="230">        <span class="co"># Fix the rpath of the generated library -- i lost the Stackoverflow</span></a>
<a class="sourceLine" id="cb1-231" data-line-number="231">        <span class="co"># reference here</span></a>
<a class="sourceLine" id="cb1-232" data-line-number="232">        from_mujoco_path <span class="op">=</span> <span class="st">&#39;@executable_path/libmujoco150.dylib&#39;</span></a>
<a class="sourceLine" id="cb1-233" data-line-number="233">        to_mujoco_path <span class="op">=</span> <span class="st">&#39;</span><span class="sc">%s</span><span class="st">/libmujoco150.dylib&#39;</span> <span class="op">%</span> mj_bin_path</a>
<a class="sourceLine" id="cb1-234" data-line-number="234">        subprocess.check_call([<span class="st">&#39;install_name_tool&#39;</span>,</a>
<a class="sourceLine" id="cb1-235" data-line-number="235">                               <span class="st">&#39;-change&#39;</span>,</a>
<a class="sourceLine" id="cb1-236" data-line-number="236">                               from_mujoco_path,</a>
<a class="sourceLine" id="cb1-237" data-line-number="237">                               to_mujoco_path,</a>
<a class="sourceLine" id="cb1-238" data-line-number="238">                               tmp_final_cext_dll_path])</a>
<a class="sourceLine" id="cb1-239" data-line-number="239"></a>
<a class="sourceLine" id="cb1-240" data-line-number="240">        from_glfw_path <span class="op">=</span> <span class="st">&#39;libglfw.3.dylib&#39;</span></a>
<a class="sourceLine" id="cb1-241" data-line-number="241">        to_glfw_path <span class="op">=</span> os.path.join(mj_bin_path, <span class="st">&#39;libglfw.3.dylib&#39;</span>)</a>
<a class="sourceLine" id="cb1-242" data-line-number="242">        subprocess.check_call([<span class="st">&#39;install_name_tool&#39;</span>,</a>
<a class="sourceLine" id="cb1-243" data-line-number="243">                               <span class="st">&#39;-change&#39;</span>,</a>
<a class="sourceLine" id="cb1-244" data-line-number="244">                               from_glfw_path,</a>
<a class="sourceLine" id="cb1-245" data-line-number="245">                               to_glfw_path,</a>
<a class="sourceLine" id="cb1-246" data-line-number="246">                               tmp_final_cext_dll_path])</a>
<a class="sourceLine" id="cb1-247" data-line-number="247"></a>
<a class="sourceLine" id="cb1-248" data-line-number="248">        os.rename(tmp_final_cext_dll_path, final_cext_dll_path)</a>
<a class="sourceLine" id="cb1-249" data-line-number="249">        <span class="cf">return</span> final_cext_dll_path</a>
<a class="sourceLine" id="cb1-250" data-line-number="250"></a>
<a class="sourceLine" id="cb1-251" data-line-number="251"></a>
<a class="sourceLine" id="cb1-252" data-line-number="252"><span class="kw">class</span> MujocoException(<span class="pp">Exception</span>):</a>
<a class="sourceLine" id="cb1-253" data-line-number="253">    <span class="cf">pass</span></a>
<a class="sourceLine" id="cb1-254" data-line-number="254"></a>
<a class="sourceLine" id="cb1-255" data-line-number="255"></a>
<a class="sourceLine" id="cb1-256" data-line-number="256"><span class="kw">def</span> user_warning_raise_exception(warn_bytes):</a>
<a class="sourceLine" id="cb1-257" data-line-number="257">    <span class="co">&#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb1-258" data-line-number="258"><span class="co">    User-defined warning callback, which is called by mujoco on warnings.</span></a>
<a class="sourceLine" id="cb1-259" data-line-number="259"><span class="co">    Here we have two primary jobs:</span></a>
<a class="sourceLine" id="cb1-260" data-line-number="260"><span class="co">        - Detect known warnings and suggest fixes (with code)</span></a>
<a class="sourceLine" id="cb1-261" data-line-number="261"><span class="co">        - Decide whether to raise an Exception and raise if needed</span></a>
<a class="sourceLine" id="cb1-262" data-line-number="262"><span class="co">    More cases should be added as we find new failures.</span></a>
<a class="sourceLine" id="cb1-263" data-line-number="263"><span class="co">    &#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb1-264" data-line-number="264">    <span class="co"># </span><span class="al">TODO</span><span class="co">: look through test output to see MuJoCo warnings to catch</span></a>
<a class="sourceLine" id="cb1-265" data-line-number="265">    <span class="co"># and recommend. Also fix those tests</span></a>
<a class="sourceLine" id="cb1-266" data-line-number="266">    warn <span class="op">=</span> warn_bytes.decode()  <span class="co"># Convert bytes to string</span></a>
<a class="sourceLine" id="cb1-267" data-line-number="267">    <span class="cf">if</span> <span class="st">&#39;Pre-allocated constraint buffer is full&#39;</span> <span class="kw">in</span> warn:</a>
<a class="sourceLine" id="cb1-268" data-line-number="268">        <span class="cf">raise</span> MujocoException(warn <span class="op">+</span> <span class="st">&#39;Increase njmax in mujoco XML&#39;</span>)</a>
<a class="sourceLine" id="cb1-269" data-line-number="269">    <span class="cf">if</span> <span class="st">&#39;Pre-allocated contact buffer is full&#39;</span> <span class="kw">in</span> warn:</a>
<a class="sourceLine" id="cb1-270" data-line-number="270">        <span class="cf">raise</span> MujocoException(warn <span class="op">+</span> <span class="st">&#39;Increase njconmax in mujoco XML&#39;</span>)</a>
<a class="sourceLine" id="cb1-271" data-line-number="271">    <span class="cf">raise</span> MujocoException(<span class="st">&#39;Got MuJoCo Warning: </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(warn))</a>
<a class="sourceLine" id="cb1-272" data-line-number="272"></a>
<a class="sourceLine" id="cb1-273" data-line-number="273"></a>
<a class="sourceLine" id="cb1-274" data-line-number="274"><span class="kw">def</span> user_warning_ignore_exception(warn_bytes):</a>
<a class="sourceLine" id="cb1-275" data-line-number="275">    <span class="cf">pass</span></a>
<a class="sourceLine" id="cb1-276" data-line-number="276"></a>
<a class="sourceLine" id="cb1-277" data-line-number="277"></a>
<a class="sourceLine" id="cb1-278" data-line-number="278"><span class="kw">class</span> ignore_mujoco_warnings:</a>
<a class="sourceLine" id="cb1-279" data-line-number="279">    <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-280" data-line-number="280"><span class="co">    Class to turn off mujoco warning exceptions within a scope. Useful for</span></a>
<a class="sourceLine" id="cb1-281" data-line-number="281"><span class="co">    large, vectorized rollouts.</span></a>
<a class="sourceLine" id="cb1-282" data-line-number="282"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb1-283" data-line-number="283"></a>
<a class="sourceLine" id="cb1-284" data-line-number="284">    <span class="kw">def</span> <span class="fu">__enter__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-285" data-line-number="285">        <span class="va">self</span>.prev_user_warning <span class="op">=</span> cymj.get_warning_callback()</a>
<a class="sourceLine" id="cb1-286" data-line-number="286">        cymj.set_warning_callback(user_warning_ignore_exception)</a>
<a class="sourceLine" id="cb1-287" data-line-number="287">        <span class="cf">return</span> <span class="va">self</span></a>
<a class="sourceLine" id="cb1-288" data-line-number="288"></a>
<a class="sourceLine" id="cb1-289" data-line-number="289">    <span class="kw">def</span> <span class="fu">__exit__</span>(<span class="va">self</span>, <span class="bu">type</span>, value, traceback):</a>
<a class="sourceLine" id="cb1-290" data-line-number="290">        cymj.set_warning_callback(<span class="va">self</span>.prev_user_warning)</a>
<a class="sourceLine" id="cb1-291" data-line-number="291"></a>
<a class="sourceLine" id="cb1-292" data-line-number="292"></a>
<a class="sourceLine" id="cb1-293" data-line-number="293">mjpro_path, key_path <span class="op">=</span> discover_mujoco()</a>
<a class="sourceLine" id="cb1-294" data-line-number="294">cymj <span class="op">=</span> load_cython_ext(mjpro_path)</a>
<a class="sourceLine" id="cb1-295" data-line-number="295"></a>
<a class="sourceLine" id="cb1-296" data-line-number="296"></a>
<a class="sourceLine" id="cb1-297" data-line-number="297"><span class="co"># Trick to expose all mj* functions from mujoco in mujoco_py.*</span></a>
<a class="sourceLine" id="cb1-298" data-line-number="298"><span class="kw">class</span> dict2(<span class="bu">object</span>):</a>
<a class="sourceLine" id="cb1-299" data-line-number="299">    <span class="cf">pass</span></a>
<a class="sourceLine" id="cb1-300" data-line-number="300"></a>
<a class="sourceLine" id="cb1-301" data-line-number="301"></a>
<a class="sourceLine" id="cb1-302" data-line-number="302">functions <span class="op">=</span> dict2()</a>
<a class="sourceLine" id="cb1-303" data-line-number="303"><span class="cf">for</span> func_name <span class="kw">in</span> <span class="bu">dir</span>(cymj):</a>
<a class="sourceLine" id="cb1-304" data-line-number="304">    <span class="cf">if</span> func_name.startswith(<span class="st">&quot;_mj&quot;</span>):</a>
<a class="sourceLine" id="cb1-305" data-line-number="305">        <span class="bu">setattr</span>(functions, func_name[<span class="dv">1</span>:], <span class="bu">getattr</span>(cymj, func_name))</a>
<a class="sourceLine" id="cb1-306" data-line-number="306"></a>
<a class="sourceLine" id="cb1-307" data-line-number="307">functions.mj_activate(key_path)</a>
<a class="sourceLine" id="cb1-308" data-line-number="308"></a>
<a class="sourceLine" id="cb1-309" data-line-number="309"><span class="co"># Set user-defined callbacks that raise assertion with message</span></a>
<a class="sourceLine" id="cb1-310" data-line-number="310">cymj.set_warning_callback(user_warning_raise_exception)</a></code></pre></div>
